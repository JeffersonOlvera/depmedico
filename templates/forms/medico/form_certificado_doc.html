{% extends 'base/base_form.html' %}
{%block title%}ACC - Colaborador{%endblock%}
{%block ficha_name%}CERTIFICADO OCUPACIONAL - ACC{%endblock%}
{%block form %}
<form method="POST" id="myForm" action="{{ url_for('certificado.actualizar') }}">
    <div class="col-md-12 mb-3">
        <label for="nombre" class="form-label">Nombre Completo</label>
        <input type="text" class="form-control" id="nombre" name="nombre" pattern="^[a-zA-Z\s]+$"
            placeholder="Nombre completo" value="{{ form_data.get('nombre', nombre | default('')) }}" required>
        <div class="form-text">Solo letras y espacios.</div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="cedula" class="form-label">Cédula</label>
            <input type="text" class="form-control" id="cedula" name="cedula" pattern="^\d{10}$"
                placeholder="0999999999" maxlength="10" value="{{ form_data.get('cedula', cedula | default('')) }}"
                required>
            <div class="form-text">Debe tener exactamente 10 dígitos.</div>
        </div>

        <div class="col-md-6 mb-3">
            <label for="nhc" class="form-label">NHC</label>
            <input type="text" class="form-control" id="nhc" name="nhc" pattern="^\d+$"
                placeholder="Número de Historia Clínica" value="{{ form_data.get('nhc', nhc | default('')) }}" required>
            <div class="form-text">Solo números.</div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="edad" class="form-label">Edad</label>
            <input type="text" class="form-control" id="edad" name="edad" pattern="^\d+$" placeholder="Edad"
                value="{{ form_data.get('edad', edad | default('')) }}" required>
            <div class="form-text">Solo números.</div>
        </div>

        <div class="col-md-6 mb-3">
            <label for="sexo" class="form-label">Sexo</label>
            <select class="form-select" id="sexo" name="sexo" required>
                <option value="" disabled>Seleccione el sexo</option>
                <option value="Femenino" {% if form_data.get('sexo')=='Femenino' %}selected{% endif %}>Femenino</option>
                <option value="Masculino" {% if form_data.get('sexo')=='Masculino' %}selected{% endif %}>Masculino
                </option>
            </select>
        </div>

    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="cargo" class="form-label">Cargo</label>
            <input type="text" class="form-control" id="cargo" name="cargo" placeholder="Cargo del empleado"
                value="{{ form_data.get('cargo', cargo | default('')) }}" required>
        </div>

        <div class="col-md-6 mb-3">
            <label for="tiempo_cargo" class="form-label">Tiempo en el Cargo</label>
            <input type="text" class="form-control" id="tiempo_cargo" name="tiempo_cargo"
                placeholder="Tiempo en el cargo" value="{{ form_data.get('tiempo_cargo', tiempo_cargo | default('')) }}"
                required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="fecha_emision" class="form-label">Fecha de Emisión</label>
            <input type="date" class="form-control" id="fecha_emision" name="fecha_emision"
                value="{{ form_data.get('fecha_emision', '') | default('') }}" required>
                
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Evaluación:</label>
            <div class="d-flex">
                <div class="form-check me-3">
                    
                    <input class="form-check-input" type="checkbox" id="ingreso" name="ingreso" value="X"
                        {% if form_data.get('ingreso') == 'Sí' or form_data.get('ingreso') == 'X' %}checked{% endif %}>
                    <label class="form-check-label" for="ingreso">Ingreso</label>
                </div>
                <div class="form-check me-3">
                    
                    <input class="form-check-input" type="checkbox" id="periodico" name="periodico" value="X"
                        {% if form_data.get('periodico') == 'Sí' or form_data.get('periodico') == 'X' %}checked{% endif %}>
                    <label class="form-check-label" for="periodico">Periódico</label>
                </div>
                <div class="form-check">
                    
                    <input class="form-check-input" type="checkbox" id="reintegro" name="reintegro" value="X"
                        {% if form_data.get('reintegro') == 'Sí' or form_data.get('reintegro') == 'X' %}checked{% endif %}>
                    <label class="form-check-label" for="reintegro">Reintegro</label>
                </div>
            </div>
        </div>

    </div>

    <div class="mb-3">
        <label class="form-label">Aptitud</label>
        <div class="d-flex">
            <div class="form-check me-3">
                <input class="form-check-input" type="radio" name="apto" id="apto" value="X" {% if
                    form_data.get('apto')=='Sí' or form_data.get('apto')=='X' %}checked{% endif %}>
                <label class="form-check-label" for="apto">Apto</label>
            </div>
            <div class="form-check me-3">
                <input class="form-check-input" type="radio" name="apto_observacion" id="apto_observacion" value="X" {%
                    if form_data.get('apto_observacion')=='Sí' or form_data.get('apto_observacion')=='X' %}checked{%
                    endif %}>
                <label class="form-check-label" for="apto_observacion">Apto con Observación</label>
            </div>
            <div class="form-check me-3">
                <input class="form-check-input" type="radio" name="apto_limitaciones" id="apto_limitaciones" value="X"
                    {% if form_data.get('apto_limitaciones')=='Sí' or form_data.get('apto_limitaciones')=='X'
                    %}checked{% endif %}>
                <label class="form-check-label" for="apto_limitaciones">Apto con Limitaciones</label>
            </div>
            <div class="form-check me-3">
                <input class="form-check-input" type="radio" name="no_apto" id="no_apto" value="X" {% if
                    form_data.get('no_apto')=='Sí' or form_data.get('no_apto')=='X' %}checked{% endif %}>
                <label class="form-check-label" for="no_apto">No Apto</label>
            </div>
        </div>
    </div>



    <div class="mb-3">
        <label for="apto_detalles" class="form-label">Detalles de Observación/Limitaciones</label>
        <textarea class="form-control" id="apto_detalles" name="apto_detalles"
            placeholder="Ingrese detalles (si es necesario)">{{ form_data.get('apto_detalles', '') }}
        </textarea>
    </div>

    <div class="mb-3">
        <label for="recomendaciones" class="form-label">Recomendaciones</label>
        <textarea class="form-control" id="recomendaciones" name="recomendaciones" placeholder="Recomendaciones"
            required>{{ form_data.get('recomendaciones', '') }}
        </textarea>
    </div>

    <p>
        Con este documento certifico que el trabajador se ha sometido a la evaluación medica requerida ingreso periódico
        retiro para puesto laboral y se ha informado sobre los riesgos relacionados con el trabajo emitiendo
        recomendaciones con su estado de salud.
    </p>


    <!-- Firma Colaborador -->
    <div class="col-md-12">
        <div class="signature-pad" id="signature-pad">
          <label class="form-label">Firma:</label>
          <canvas id="signature-canvas"></canvas>
          <div class="btn-group">
            <button type="button" id="clear-signature" class="btn btn-secondary">
              Limpiar
            </button>
          </div>
        </div>
    
        <input type="hidden" id="firma_colaborador" name="firma_colaborador" />
      </div>

    <button type="submit" class="btn btn-primary mt-4 w-100">Enviar</button>
</form>

{%endblock%}
{%block scripts%}
<script src="{{ url_for('static', filename='js/radio_btn.js') }}"></script>

<script>
    window.onload = function () {
        var canvas = document.getElementById('signature-canvas');
        var context = canvas.getContext('2d');
        var signaturePad = new SignaturePad(canvas);
      
        // Redimensiona el canvas según la ventana
        function resizeCanvas() {
          var ratio = Math.max(window.devicePixelRatio || 1, 1);
          canvas.width = canvas.offsetWidth * ratio;
          canvas.height = canvas.offsetHeight * ratio;
          context.scale(ratio, ratio);
      
          // Recargar la imagen después de redimensionar si existe
          loadExistingSignature();
        }
      
        // Función para guardar automáticamente la firma
        function autoSaveSignature() {
          if (!signaturePad.isEmpty()) {
            var dataURL = signaturePad.toDataURL('image/png');
            document.getElementById('firma_colaborador').value = dataURL;
            console.log('Firma guardada automáticamente');
          } else {
            // Si está vacía, limpiar el campo oculto
            document.getElementById('firma_colaborador').value = '';
            console.log('Firma limpiada automáticamente');
          }
        }
      
        // Función para cargar la firma existente
        function loadExistingSignature() {
          // Corregir la obtención del base64 desde el backend
          var base64FirmaGuardada = "{{ form_data.Firma_colaborador|default('') }}";
          
          if (base64FirmaGuardada && base64FirmaGuardada.trim() !== '') {
            // Verificar que el base64 tenga el formato correcto
            if (!base64FirmaGuardada.startsWith('data:image/')) {
              base64FirmaGuardada = 'data:image/png;base64,' + base64FirmaGuardada;
            }
            
            var image = new Image();
            image.onload = function () {
              // Usar SignaturePad para cargar la imagen en lugar de dibujarla directamente
              signaturePad.fromDataURL(base64FirmaGuardada);
              
              // También actualizar el input hidden con el valor existente
              document.getElementById('firma_colaborador').value = base64FirmaGuardada;
            };
            image.onerror = function() {
              console.error('Error al cargar la firma existente');
            };
            image.src = base64FirmaGuardada;
          }
        }
      
        // Ajustar tamaño del canvas al cargar la página
        window.onresize = resizeCanvas;
        resizeCanvas();
      
        // Función para centrar y escalar la imagen en el canvas
        function drawCenteredImage(image) {
          var canvasAspect = canvas.width / canvas.height;
          var imageAspect = image.width / image.height;
          var renderableWidth, renderableHeight, xStart, yStart;
      
          // Ajustar el tamaño de la imagen para que encaje en el canvas
          if (imageAspect < canvasAspect) {
            // La imagen es más alta que el canvas, ajustar el ancho
            renderableHeight = canvas.height;
            renderableWidth = image.width * (canvas.height / image.height);
            xStart = (canvas.width - renderableWidth) / 2;
            yStart = 0;
          } else {
            // La imagen es más ancha que el canvas, ajustar la altura
            renderableWidth = canvas.width;
            renderableHeight = image.height * (canvas.width / image.width);
            xStart = 0;
            yStart = (canvas.height - renderableHeight) / 2;
          }
      
          // Dibujar la imagen centrada
          context.clearRect(0, 0, canvas.width, canvas.height); // Limpiar el canvas antes de dibujar
          context.drawImage(image, xStart, yStart, renderableWidth, renderableHeight);
        }
      
        // Cargar la firma guardada si existe y centrarla
        var base64FirmaGuardada = "{{ form_data.get('firma_colaborador', firma_colaborador | default('')) }}";

        console.log('Firma guardada:', base64FirmaGuardada); // Para depuración 
        if (base64FirmaGuardada) {
          var image = new Image();
          image.src = base64FirmaGuardada;
          image.onload = function () {
            drawCenteredImage(image); // Llamar a la función para dibujar la imagen centrada
          };
        }
      
        // Eventos de auto-guardado
        // Guardar automáticamente al finalizar el trazo
        signaturePad.onEnd = function() {
          autoSaveSignature();
        };
      
        // Limpiar firma
        document.getElementById('clear-signature').addEventListener('click', function () {
          signaturePad.clear();
          autoSaveSignature(); // Guardar automáticamente después de limpiar
        });
      
        // Eliminar el botón de guardar (opcional) o simplemente no hacer nada
        var saveButton = document.getElementById('save-signature');
        if (saveButton) {
          saveButton.style.display = 'none'; // Ocultar el botón de guardar
          // O alternativamente, puedes remover completamente el event listener
          // saveButton.removeEventListener('click', function() {});
        }
      };
</script>

{%endblock%}