{% extends 'base/base_form.html' %}
{%block title%}ACC - Colaborador{%endblock%}
{%block ficha_name%}CONSENTIMIENTO INFORMADO - ACC{%endblock%}
{%block form %}

<div class="container mt-5">
  <div class="card mb-5 p-4 shadow-sm">
    <p style="font-weight: 600; text-align: center;">CONSENTIMIENTO INFORMADO PARA PROCEDIMIENTOS, VALORACIONES
      OCUPACIONALES</p>
    <p>El Consultorio Médico de American Call Center tiene el permiso correspondiente para el funcionamiento <span
        id="anio"></span> otorgado por el Ministerio de Salud Pública para actividades preventivas y curativas.</p>

    <p>Al rellenar los siguientes datos, autorizo permiso para procedimientos tales como:</p>
    <ul>
      <li>Toma de muestras de exámenes de laboratorio </li>
    </ul>
    <ul>
      <li>Curación de heridas en caso de emergencia </li>
    </ul>
    <ul>
      <li>Suruta en caso de emergencia</li>
    </ul>
    <ul>
      <li>Exámenes ginecológicos, genital</li>
    </ul>
    <ul>
      <li>Traslado al centro de atención de alta complejidad IESS - MSP en caso de emergencia</li>
    </ul>
    <ul>
      <li>Valoraciones ocupacionales: audiometrías/ optometría </li>
    </ul>
    <ul>
      <li>Tamizajes de rutina o por conceptos de campañas </li>
    </ul>

  </div>
  <form method="POST" id="myForm" action="{{ url_for('consentimiento.actualizar') }}">
    <div class="mb-3">
      <label for="nombre" class="form-label fw-bold">Nombre completo</label>
      <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Nombre completo"
        pattern="^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$" maxlength="60" required
        value="{{ form_data.get('Nombre', Nombre | default('')) }}"
        title="El nombre solo puede contener letras y espacios."
        oninvalid="this.setCustomValidity('El nombre solo puede contener letras y espacios.')"
        oninput="this.setCustomValidity('')">

    </div>
    <div class="row">
      <div class="mb-3 col-6">
        <label for="cedula" class="form-label fw-bold">Cédula</label>
        <input type="text" class="form-control" id="cedula" name="cedula" placeholder="N° Cédula - 0999999999"
          pattern="^\d{10}$" value="{{ form_data.get('Cedula', Cedula | default('')) }}"
          title="El número de cédula debe tener 10 dígitos."
          oninvalid="this.setCustomValidity('El número de cédula debe tener 10 dígitos.')"
          oninput="this.setCustomValidity('')" maxlength="10" required>
      </div>


      <div class="mb-3 col-6">
        <label for="fecha" class="form-label fw-bold">Fecha</label>
        <input type="date" class="form-control" id="fecha" value="{{ form_data.get('Fecha', Fecha | default('')) }}"
          name="fecha" required>
      </div>
    </div>


    <div class="col-md-12 mb-3">
      <div class="signature-pad" id="signature-pad">
        <label class="form-label fw-bold">Firma:</label>
        <canvas id="signature-canvas"></canvas>
        <div class="btn-group">
          <button type="button" id="clear-signature" class="btn btn-danger">
            Limpiar
          </button>
          <button type="button" id="save-signature" class="btn btn-primary">
            Guardar
          </button>
        </div>
      </div>

      <input type="hidden" id="firma" name="firma" />
    </div>


    <button type="submit" class="btn btn-primary mt-4 w-100">Enviar</button>
  </form>
</div>


{%endblock%}
{%block scripts%}
<script>
  window.onload = function () {
      var canvas = document.getElementById('signature-canvas');
      var context = canvas.getContext('2d');
      var signaturePad = new SignaturePad(canvas);
    
      // Redimensiona el canvas según la ventana
      function resizeCanvas() {
        var ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        context.scale(ratio, ratio);
    
        // Recargar la imagen después de redimensionar si existe
        loadExistingSignature();
      }
    
      // Función para guardar automáticamente la firma
      function autoSaveSignature() {
        if (!signaturePad.isEmpty()) {
          var dataURL = signaturePad.toDataURL('image/png');
          document.getElementById('firma').value = dataURL;
          console.log('Firma guardada automáticamente');
        } else {
          // Si está vacía, limpiar el campo oculto
          document.getElementById('firma').value = '';
          console.log('Firma limpiada automáticamente');
        }
      }
    
      // Función para cargar la firma existente
      function loadExistingSignature() {
        // Corregir la obtención del base64 desde el backend
        var base64FirmaGuardada = "{{ form_data.Firma|default('') }}";
        
        if (base64FirmaGuardada && base64FirmaGuardada.trim() !== '') {
          // Verificar que el base64 tenga el formato correcto
          if (!base64FirmaGuardada.startsWith('data:image/')) {
            base64FirmaGuardada = 'data:image/png;base64,' + base64FirmaGuardada;
          }
          
          var image = new Image();
          image.onload = function () {
            // Usar SignaturePad para cargar la imagen en lugar de dibujarla directamente
            signaturePad.fromDataURL(base64FirmaGuardada);
            
            // También actualizar el input hidden con el valor existente
            document.getElementById('firma').value = base64FirmaGuardada;
          };
          image.onerror = function() {
            console.error('Error al cargar la firma existente');
          };
          image.src = base64FirmaGuardada;
        }
      }
    
      // Ajustar tamaño del canvas al cargar la página
      window.onresize = resizeCanvas;
      resizeCanvas();
    
      // Función para centrar y escalar la imagen en el canvas
      function drawCenteredImage(image) {
        var canvasAspect = canvas.width / canvas.height;
        var imageAspect = image.width / image.height;
        var renderableWidth, renderableHeight, xStart, yStart;
    
        // Ajustar el tamaño de la imagen para que encaje en el canvas
        if (imageAspect < canvasAspect) {
          // La imagen es más alta que el canvas, ajustar el ancho
          renderableHeight = canvas.height;
          renderableWidth = image.width * (canvas.height / image.height);
          xStart = (canvas.width - renderableWidth) / 2;
          yStart = 0;
        } else {
          // La imagen es más ancha que el canvas, ajustar la altura
          renderableWidth = canvas.width;
          renderableHeight = image.height * (canvas.width / image.width);
          xStart = 0;
          yStart = (canvas.height - renderableHeight) / 2;
        }
    
        // Dibujar la imagen centrada
        context.clearRect(0, 0, canvas.width, canvas.height); // Limpiar el canvas antes de dibujar
        context.drawImage(image, xStart, yStart, renderableWidth, renderableHeight);
      }
    
      // Cargar la firma guardada si existe y centrarla
      var base64FirmaGuardada = "{{ form_data.get('firma', firma | default('')) }}";

      console.log('Firma guardada:', base64FirmaGuardada); // Para depuración 
      if (base64FirmaGuardada) {
        var image = new Image();
        image.src = base64FirmaGuardada;
        image.onload = function () {
          drawCenteredImage(image); // Llamar a la función para dibujar la imagen centrada
        };
      }
    
      // Eventos de auto-guardado
      // Guardar automáticamente al finalizar el trazo
      signaturePad.onEnd = function() {
        autoSaveSignature();
      };
    
      // Limpiar firma
      document.getElementById('clear-signature').addEventListener('click', function () {
        signaturePad.clear();
        autoSaveSignature(); // Guardar automáticamente después de limpiar
      });
    
      // Eliminar el botón de guardar (opcional) o simplemente no hacer nada
      var saveButton = document.getElementById('save-signature');
      if (saveButton) {
        saveButton.style.display = 'none'; // Ocultar el botón de guardar
        // O alternativamente, puedes remover completamente el event listener
        // saveButton.removeEventListener('click', function() {});
      }
    };
</script>

<span id="anio"></span>

<script>
  // Obtiene el año actual
  const currentYear = new Date().getFullYear();

  // Asigna el año al elemento con id="anio"
  document.getElementById('anio').textContent = currentYear;
</script>


{%endblock%}